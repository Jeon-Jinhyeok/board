/**
 * 게시글 페이지 E2E 테스트
 * 
 * 이 파일은 게시글 관련 페이지를 테스트합니다.
 * - 게시글 상세 페이지
 * - 게시글 작성 페이지
 * - 게시글 목록에서 상세로 이동
 */

import { test, expect } from '@playwright/test';

// ============================================================
// 테스트 그룹: 게시글 상세 페이지
// ============================================================
test.describe('게시글 상세 페이지 테스트', () => {

  /**
   * 테스트 1: 게시글 목록에서 상세 페이지로 이동
   * 
   * 목적: 게시글 클릭 시 상세 페이지로 정상 이동하는지 확인
   */
  test('게시글 제목을 클릭하면 상세 페이지로 이동한다', async ({ page }) => {
    // 홈페이지로 이동
    await page.goto('/');
    
    // --------------------------------------------------------
    // page.locator('tbody tr'): 테이블 본문의 행(<tr>)을 찾습니다
    // .first(): 첫 번째 요소만 선택
    // 
    // 게시글이 없을 수 있으므로 조건부 테스트 진행
    // --------------------------------------------------------
    const firstRow = page.locator('tbody tr').first();
    const rowCount = await firstRow.count();
    
    // 게시글이 있는 경우에만 테스트 진행
    if (rowCount > 0) {
      // --------------------------------------------------------
      // locator('td a'): 테이블 셀 안의 링크를 찾습니다
      // .click(): 해당 요소를 클릭합니다
      // Playwright는 클릭 전에 요소가 클릭 가능한 상태인지 자동 확인
      // --------------------------------------------------------
      const postLink = firstRow.locator('td a').first();
      
      // 링크가 있으면 클릭
      if (await postLink.count() > 0) {
        await postLink.click();
        
        // --------------------------------------------------------
        // URL이 '/posts/숫자' 패턴인지 확인
        // 정규식 /\/posts\/\d+/는 '/posts/' 뒤에 숫자가 오는 패턴
        // --------------------------------------------------------
        await expect(page).toHaveURL(/\/posts\/\d+/);
      }
    }
    // 게시글이 없으면 테스트 스킵 (통과 처리)
  });

  /**
   * 테스트 2: 게시글 상세 페이지 직접 접근 (게시글 ID 1 가정)
   * 
   * 주의: 이 테스트는 ID가 1인 게시글이 존재한다고 가정합니다
   * 실제 환경에서는 테스트용 데이터 설정이 필요합니다
   */
  test('게시글 상세 페이지에서 제목과 내용이 표시된다', async ({ page }) => {
    // --------------------------------------------------------
    // 게시글이 있는지 먼저 확인
    // --------------------------------------------------------
    await page.goto('/');
    
    const postLink = page.locator('tbody tr td a').first();
    
    if (await postLink.count() > 0) {
      // 첫 번째 게시글의 href 속성 가져오기
      const href = await postLink.getAttribute('href');
      
      if (href) {
        await page.goto(href);
        
        // --------------------------------------------------------
        // 상세 페이지에 있어야 할 요소들 확인:
        // - 게시글 제목
        // - 게시글 내용
        // - 작성자 정보
        // --------------------------------------------------------
        
        // 페이지 내에 텍스트 콘텐츠가 있는지 확인
        const body = page.locator('body');
        await expect(body).toBeVisible();
        
        // main 콘텐츠 영역이 있는지 확인
        const main = page.locator('main');
        if (await main.count() > 0) {
          await expect(main).toBeVisible();
        }
      }
    }
  });
});

// ============================================================
// 테스트 그룹: 게시글 작성 페이지
// ============================================================
test.describe('게시글 작성 페이지 테스트', () => {

  /**
   * 테스트 1: 글쓰기 페이지 직접 접근 (비로그인 상태)
   * 
   * 목적: 비로그인 상태에서 글쓰기 페이지 접근 시 
   * 로그인 페이지로 리다이렉트되는지 확인
   */
  test('비로그인 상태에서 글쓰기 페이지 접근 시 로그인으로 리다이렉트된다', async ({ page }) => {
    // --------------------------------------------------------
    // /posts/write로 직접 접근 시도
    // Spring Security가 설정되어 있다면 로그인 페이지로 리다이렉트
    // --------------------------------------------------------
    await page.goto('/posts/write');
    
    // --------------------------------------------------------
    // 두 가지 가능한 결과:
    // 1. 로그인 페이지로 리다이렉트됨 (보안 설정 O)
    // 2. 글쓰기 페이지가 그대로 표시됨 (보안 설정 X)
    //
    // URL에 'login'이 포함되어 있으면 리다이렉트된 것
    // --------------------------------------------------------
    const currentUrl = page.url();
    
    // 로그인 페이지로 리다이렉트되었거나, 글쓰기 페이지가 표시됨
    const isLoginPage = currentUrl.includes('login');
    const isWritePage = currentUrl.includes('write');
    
    // 둘 중 하나여야 함
    expect(isLoginPage || isWritePage).toBeTruthy();
    
    if (isLoginPage) {
      // 로그인 폼이 있는지 확인
      await expect(page.locator('input[type="password"]').first()).toBeVisible();
    }
  });

  /**
   * 테스트 2: 글쓰기 폼 요소 확인
   * 
   * 주의: 이 테스트는 로그인 상태에서 실행되어야 함
   * 현재는 로그인 없이 폼 요소만 확인 (페이지 접근 가능한 경우)
   */
  test('글쓰기 페이지에 필요한 폼 요소가 있다 (페이지 접근 가능 시)', async ({ page }) => {
    await page.goto('/posts/write');
    
    // 글쓰기 페이지에 있는 경우에만 테스트
    const currentUrl = page.url();
    
    if (currentUrl.includes('write')) {
      // --------------------------------------------------------
      // 글쓰기 폼에 필요한 요소들:
      // - 제목 입력 필드
      // - 내용 입력 필드 (textarea)
      // - 카테고리 선택 (select) - 선택적
      // - 등록 버튼
      // --------------------------------------------------------
      
      // 제목 입력 필드 확인
      const titleInput = page.locator('input[name="title"], input[id*="title"]');
      if (await titleInput.count() > 0) {
        await expect(titleInput.first()).toBeVisible();
      }
      
      // 내용 입력 필드 확인 (textarea 또는 에디터)
      const contentArea = page.locator('textarea, [contenteditable="true"]');
      if (await contentArea.count() > 0) {
        await expect(contentArea.first()).toBeVisible();
      }
    }
  });
});

// ============================================================
// 테스트 그룹: 네비게이션 테스트
// ============================================================
test.describe('게시판 네비게이션 테스트', () => {

  /**
   * 테스트: 홈으로 돌아가기
   * 
   * 목적: 다른 페이지에서 홈으로 돌아올 수 있는지 확인
   */
  test('네비게이션 바에서 홈으로 돌아갈 수 있다', async ({ page }) => {
    // 로그인 페이지로 먼저 이동
    await page.goto('/user/login');
    
    // --------------------------------------------------------
    // 네비게이션 바에서 홈 링크 찾기
    // 'Spring Board' 또는 '홈' 텍스트를 가진 링크
    // --------------------------------------------------------
    const homeLink = page.locator('nav a').first();
    
    if (await homeLink.count() > 0) {
      await homeLink.click();
      
      // --------------------------------------------------------
      // page.waitForURL(): 특정 URL 패턴이 될 때까지 대기
      // 루트 경로('/')로 이동했는지 확인
      // --------------------------------------------------------
      await page.waitForURL(/\/?(\?.*)?$/);
    }
  });
});
