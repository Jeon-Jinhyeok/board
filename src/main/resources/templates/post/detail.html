<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
	<head
		th:replace="~{fragments/layout :: head('게시글 - Spring Board')}"
	></head>
	<body class="d-flex flex-column">
		<nav th:replace="~{fragments/layout :: navbar}"></nav>

		<main class="flex-grow-1 py-5">
			<div class="container" style="max-width: 900px">
				<!-- Breadcrumb -->
				<nav aria-label="breadcrumb" class="animate-fade-in">
					<ol class="breadcrumb">
						<li class="breadcrumb-item">
							<a href="/" class="text-decoration-none">홈</a>
						</li>
						<li class="breadcrumb-item active">게시글</li>
					</ol>
				</nav>

				<!-- 게시글 카드 -->
				<div
					class="card card-custom animate-fade-in"
					style="animation-delay: 0.1s"
				>
					<div class="card-body p-4 p-md-5">
						<!-- 카테고리 -->
						<div th:if="${post.categoryName}" class="mb-2">
							<span class="badge bg-info-subtle text-info">
								<i class="bi bi-tag-fill me-1"></i>
								<span th:text="${post.categoryName}">카테고리</span>
							</span>
						</div>

						<!-- 제목 -->
						<h1 class="fw-bold mb-3" th:text="${post.title}">게시글 제목</h1>

						<!-- 메타 정보 -->
						<div
							class="d-flex flex-wrap align-items-center gap-3 mb-4 pb-4 border-bottom"
						>
							<div class="d-flex align-items-center">
								<div
									class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2"
									style="width: 36px; height: 36px"
								>
									<i class="bi bi-person-fill text-white small"></i>
								</div>
								<div>
									<span class="fw-semibold" th:text="${post.writer}"
										>작성자</span
									>
								</div>
							</div>

							<div class="text-muted small">
								<i class="bi bi-calendar3 me-1"></i>
								<span
									th:text="${#temporals.format(post.createdAt, 'yyyy년 MM월 dd일 HH:mm')}"
									>2024년 01월 01일 12:00</span
								>
							</div>

							<div class="text-muted small">
								<i class="bi bi-eye me-1"></i>
								조회 <span th:text="${post.viewCount} ?: 0">0</span>
							</div>
						</div>

						<!-- 본문 내용 -->
						<div
							class="post-content mb-4"
							style="min-height: 200px; line-height: 1.8; white-space: pre-wrap"
							th:text="${post.content}"
						>
							게시글 내용이 여기에 표시됩니다.
						</div>

						<!-- 좋아요/싫어요/북마크 -->
						<div
							class="d-flex justify-content-center gap-3 py-4 border-top border-bottom mb-4"
						>
							<button
								id="likeBtn"
								class="btn btn-outline-primary rounded-pill px-4"
								th:data-post-id="${post.id}"
								onclick="toggleLike()"
							>
								<i class="bi bi-hand-thumbs-up me-1"></i>
								좋아요
								<span id="likeCount" th:text="${post.likeCount} ?: 0">0</span>
							</button>
							<button
								id="dislikeBtn"
								class="btn btn-outline-secondary rounded-pill px-4"
								th:data-post-id="${post.id}"
								onclick="toggleDislike()"
							>
								<i class="bi bi-hand-thumbs-down me-1"></i>
								싫어요
								<span id="dislikeCount" th:text="${post.dislikeCount} ?: 0"
									>0</span
								>
							</button>
							<button
								id="bookmarkBtn"
								class="btn rounded-pill px-4"
								th:classappend="${isBookmarked} ? 'btn-warning' : 'btn-outline-warning'"
								onclick="toggleBookmark()"
							>
								<i
									id="bookmarkIcon"
									class="bi me-1"
									th:classappend="${isBookmarked} ? 'bi-bookmark-fill' : 'bi-bookmark'"
								></i>
								북마크
							</button>
						</div>

						<!-- 하단 버튼들 -->
						<div class="d-flex justify-content-between align-items-center">
							<a href="/" class="btn btn-outline-secondary">
								<i class="bi bi-arrow-left me-1"></i>목록으로
							</a>

							<!-- 작성자 본인만 수정/삭제 버튼 표시 -->
							<div th:if="${post.isOwner}" class="d-flex gap-2">
								<a
									th:href="@{/posts/{id}/edit(id=${post.id})}"
									class="btn btn-outline-primary"
								>
									<i class="bi bi-pencil me-1"></i>수정
								</a>
								<form
									th:action="@{/posts/{id}(id=${post.id})}"
									method="post"
									style="display: inline"
									onsubmit="return confirm('정말 삭제하시겠습니까?');"
								>
									<input type="hidden" name="_method" value="DELETE" />
									<button type="submit" class="btn btn-outline-danger">
										<i class="bi bi-trash me-1"></i>삭제
									</button>
								</form>
							</div>
						</div>
					</div>
				</div>

				<!-- 댓글 섹션 -->
				<div
					class="card card-custom mt-4 animate-fade-in"
					style="animation-delay: 0.2s"
				>
					<div class="card-body p-4">
						<h5 class="fw-bold mb-4">
							<i class="bi bi-chat-dots me-2"></i>댓글
							<span
								id="commentCount"
								class="badge bg-primary-subtle text-primary ms-2"
								th:text="${totalCommentCount}"
								>0</span
							>
						</h5>

						<!-- 댓글 작성 폼 -->
						<div sec:authorize="isAuthenticated()" class="mb-4">
							<div class="d-flex gap-3">
								<div
									class="bg-secondary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
									style="width: 40px; height: 40px"
								>
									<i class="bi bi-person-fill text-white"></i>
								</div>
								<div class="flex-grow-1">
									<textarea
										id="commentContent"
										class="form-control form-control-custom"
										rows="3"
										placeholder="댓글을 작성해주세요"
										maxlength="500"
									></textarea>
									<div
										class="d-flex justify-content-between align-items-center mt-2"
									>
										<small class="text-muted"
											><span id="charCount">0</span>/500</small
										>
										<button
											class="btn btn-primary-custom btn-sm"
											onclick="submitComment()"
										>
											<i class="bi bi-send me-1"></i>등록
										</button>
									</div>
								</div>
							</div>
						</div>

						<div
							sec:authorize="!isAuthenticated()"
							class="text-center py-4 text-muted"
						>
							<i class="bi bi-lock fs-3 d-block mb-2"></i>
							<p class="mb-2">댓글을 작성하려면 로그인이 필요합니다</p>
							<a href="/users/login" class="btn btn-outline-primary btn-sm">
								<i class="bi bi-box-arrow-in-right me-1"></i>로그인하기
							</a>
						</div>

						<!-- 댓글 목록 -->
						<div id="commentList">
							<!-- 댓글이 없을 때 -->
							<div
								th:if="${comments.empty}"
								class="text-center py-4 text-muted border-top"
							>
								<i class="bi bi-chat-left fs-3 d-block mb-2"></i>
								<p class="mb-0">아직 댓글이 없습니다</p>
								<p class="small">첫 번째 댓글을 작성해보세요!</p>
							</div>

							<!-- 댓글 있을 때 -->
							<div th:if="${!comments.empty}" class="border-top pt-4">
								<div th:each="comment : ${comments.content}" class="mb-4">
									<!-- 부모 댓글 -->
									<div class="d-flex gap-3" th:id="'comment-' + ${comment.id}">
										<div
											class="bg-primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
											style="width: 40px; height: 40px"
										>
											<i class="bi bi-person-fill text-white"></i>
										</div>
										<div class="flex-grow-1">
											<div
												class="d-flex justify-content-between align-items-start"
											>
												<div>
													<span
														class="fw-semibold"
														th:text="${comment.writerName}"
														>작성자</span
													>
													<small
														class="text-muted ms-2"
														th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}"
														>2024.01.01 12:00</small
													>
												</div>
												<!-- 본인 댓글일 때 수정/삭제 버튼 -->
												<div
													th:if="${comment.owner && !comment.deleted}"
													class="dropdown"
												>
													<button
														class="btn btn-sm btn-link text-muted p-0"
														data-bs-toggle="dropdown"
													>
														<i class="bi bi-three-dots-vertical"></i>
													</button>
													<ul class="dropdown-menu dropdown-menu-end">
														<li>
															<a
																class="dropdown-item"
																href="#"
																th:onclick="'editComment(' + ${comment.id} + ')'"
																><i class="bi bi-pencil me-2"></i>수정</a
															>
														</li>
														<li>
															<a
																class="dropdown-item text-danger"
																href="#"
																th:onclick="'deleteComment(' + ${comment.id} + ')'"
																><i class="bi bi-trash me-2"></i>삭제</a
															>
														</li>
													</ul>
												</div>
											</div>
											<p
												class="mb-2 mt-1"
												th:classappend="${comment.deleted} ? 'text-muted fst-italic' : ''"
												th:text="${comment.content}"
											>
												댓글 내용
											</p>
											<!-- 대댓글 작성 버튼 -->
											<button
												sec:authorize="isAuthenticated()"
												th:if="${!comment.deleted}"
												class="btn btn-sm btn-link text-muted p-0"
												th:onclick="'showReplyForm(' + ${comment.id} + ')'"
											>
												<i class="bi bi-reply me-1"></i>답글
											</button>

											<!-- 대댓글 작성 폼 (숨김) -->
											<div
												th:id="'replyForm-' + ${comment.id}"
												class="mt-3 d-none"
											>
												<div class="d-flex gap-2">
													<textarea
														th:id="'replyContent-' + ${comment.id}"
														class="form-control form-control-sm"
														rows="2"
														placeholder="답글을 작성해주세요"
														maxlength="500"
													></textarea>
												</div>
												<div class="text-end mt-2">
													<button
														class="btn btn-sm btn-outline-secondary me-1"
														th:onclick="'hideReplyForm(' + ${comment.id} + ')'"
													>
														취소
													</button>
													<button
														class="btn btn-sm btn-primary"
														th:onclick="'submitReply(' + ${comment.id} + ')'"
													>
														등록
													</button>
												</div>
											</div>

											<!-- 대댓글 목록 -->
											<div
												th:if="${!#lists.isEmpty(comment.replies)}"
												class="mt-3"
											>
												<div
													th:each="reply : ${comment.replies}"
													class="d-flex gap-2 mb-3 ps-3 border-start"
													th:id="'comment-' + ${reply.id}"
												>
													<div
														class="bg-secondary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
														style="width: 32px; height: 32px"
													>
														<i class="bi bi-person-fill text-white small"></i>
													</div>
													<div class="flex-grow-1">
														<div
															class="d-flex justify-content-between align-items-start"
														>
															<div>
																<span
																	class="fw-semibold small"
																	th:text="${reply.writerName}"
																	>작성자</span
																>
																<small
																	class="text-muted ms-2"
																	th:text="${#temporals.format(reply.createdAt, 'yyyy.MM.dd HH:mm')}"
																	>2024.01.01 12:00</small
																>
															</div>
															<!-- 본인 대댓글일 때 수정/삭제 버튼 -->
															<div
																th:if="${reply.owner && !reply.deleted}"
																class="dropdown"
															>
																<button
																	class="btn btn-sm btn-link text-muted p-0"
																	data-bs-toggle="dropdown"
																>
																	<i class="bi bi-three-dots-vertical"></i>
																</button>
																<ul class="dropdown-menu dropdown-menu-end">
																	<li>
																		<a
																			class="dropdown-item"
																			href="#"
																			th:onclick="'editComment(' + ${reply.id} + ')'"
																			><i class="bi bi-pencil me-2"></i>수정</a
																		>
																	</li>
																	<li>
																		<a
																			class="dropdown-item text-danger"
																			href="#"
																			th:onclick="'deleteComment(' + ${reply.id} + ')'"
																			><i class="bi bi-trash me-2"></i>삭제</a
																		>
																	</li>
																</ul>
															</div>
														</div>
														<p
															class="mb-0 mt-1 small"
															th:classappend="${reply.deleted} ? 'text-muted fst-italic' : ''"
															th:text="${reply.content}"
														>
															대댓글 내용
														</p>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- 페이징 -->
							<nav
								th:if="${comments.totalPages > 1}"
								aria-label="댓글 페이지 네비게이션"
								class="mt-4"
							>
								<ul
									class="pagination pagination-sm justify-content-center mb-0"
								>
									<!-- 이전 페이지 -->
									<li
										class="page-item"
										th:classappend="${comments.first} ? 'disabled'"
									>
										<a
											class="page-link"
											th:href="@{/posts/{id}(id=${post.id}, page=${comments.number - 1})}"
											th:if="${!comments.first}"
										>
											<i class="bi bi-chevron-left"></i>
										</a>
										<span class="page-link" th:if="${comments.first}">
											<i class="bi bi-chevron-left"></i>
										</span>
									</li>

									<!-- 페이지 번호 -->
									<th:block
										th:with="start=${T(java.lang.Math).max(0, comments.number - 2)}, end=${T(java.lang.Math).min(comments.totalPages - 1, comments.number + 2)}"
									>
										<li
											th:each="i : ${#numbers.sequence(start, end)}"
											class="page-item"
											th:classappend="${i == comments.number} ? 'active'"
										>
											<a
												class="page-link"
												th:href="@{/posts/{id}(id=${post.id}, page=${i})}"
												th:text="${i + 1}"
												>1</a
											>
										</li>
									</th:block>

									<!-- 다음 페이지 -->
									<li
										class="page-item"
										th:classappend="${comments.last} ? 'disabled'"
									>
										<a
											class="page-link"
											th:href="@{/posts/{id}(id=${post.id}, page=${comments.number + 1})}"
											th:if="${!comments.last}"
										>
											<i class="bi bi-chevron-right"></i>
										</a>
										<span class="page-link" th:if="${comments.last}">
											<i class="bi bi-chevron-right"></i>
										</span>
									</li>
								</ul>
							</nav>
						</div>
					</div>
				</div>
			</div>
		</main>

		<footer th:replace="~{fragments/layout :: footer}"></footer>
		<th:block th:replace="~{fragments/layout :: scripts}"></th:block>

		<script src="/js/common.js"></script>
		<script src="/js/detail.js"></script>
		<script th:inline="javascript">
			const postId = /*[[${post.id}]]*/ 0;
		</script>
	</body>
</html>
